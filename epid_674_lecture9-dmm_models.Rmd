---
title: "EPID 674 - Lecture 9 - Dirichlet-Multinomial Mixture Modeling"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = FALSE)
```

__Load the Tidyverse__

* We have to explicitly load the packages that we will use for our analysis.

```{r load_tidyverse, echo=TRUE, eval=TRUE}

library(tidyverse)

```

***

__Install the DirichletMultinomial Package via Bioconductor__

* Bioconductor is a repository of bioinformatics software.

```{r load_dirichletmultinomial, echo=TRUE, eval=TRUE}

source("https://bioconductor.org/biocLite.R")
biocLite("DirichletMultinomial")
library(DirichletMultinomial)

```

***

__Install the Viridis Package for Heatmaps__

* Viridis provides color palettes that (1) span a wide color range, making differences easy to see; (2) are perceptually uniform, meaning that values close to each other have similar-appearing colors and values far away from each other have more different-appearing colors; and are (3) robust to colorblindness, so that the above properties hold true for people with common forms ofcolorblindness, as well as in grey scale printing.

```{r load_viridis, echo=TRUE, eval=TRUE}

#install.packages("viridis")
library(viridis)

```

***


__Load & Tidy the Data__

* Today, we will again evaluate an OTU table from a study of respiratory tract microbiome (OP = oropharyngeal, ET = endotracheal), which is described here: https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-016-0151-8

```{r load_otus, echo=TRUE, eval=TRUE, fig.align='center'}

icu_otus <- read_tsv(file = "./data/icu_de_novo_otu_table_op_et.txt") # we skip the first line because it holds a file descriptor, not tabular data

icu_assignments <- read_tsv(file = "./data/icu_de_novo_assignment_ltp_genus.txt")

icu_otus %>%
  dplyr::rename(otu_id = '#OTU ID') %>%
  gather(key = "specimen_id", value = "read_count", -otu_id) %>%
  left_join(icu_assignments, by = "otu_id") %>%
  mutate(subject_id = str_extract(string = specimen_id, pattern = "001|002|003|004|005|006|007|008|009|010|011|012|013|014|015"),
         specimen_type = str_extract(string = specimen_id, pattern = "ET|OP"),
         collection_date = as.Date(str_sub(string = specimen_id, start = 12, end = 19), format = "%Y%m%d")) %>%
  group_by(subject_id) %>%
  mutate(days_since_enrollment = as.numeric(collection_date - min(collection_date))) %>%
  ungroup() -> tidy_icu_final

tidy_icu_final %>%
  dplyr::slice(1:11)

```

__Convert Tidy Data to Matrix Form__

* Prior to DMM modeling, we must convert our tidy data to matrix form:

```{r otus_matrix, echo=TRUE, eval=TRUE, fig.align='center'}

tidy_icu_final %>%
  select(otu_id,specimen_id,read_count) %>%
  spread(key = specimen_id, value = read_count) %>%
  as.matrix(.) -> icu_matrix

rownames(icu_matrix) <- icu_matrix[,1]
icu_matrix <- icu_matrix[,-1]
icu_matrix <- apply(icu_matrix, MARGIN = c(1,2), FUN = function(x) {as.numeric(x)})
str(icu_matrix)


tidy_icu_final %>%
  filter(specimen_type == "ET") %>%
  select(otu_id,specimen_id,read_count) %>%
  spread(key = specimen_id, value = read_count) %>%
  as.matrix(.) -> icu_matrix_et

rownames(icu_matrix_et) <- icu_matrix_et[,1]
icu_matrix_et <- icu_matrix_et[,-1]
icu_matrix_et <- apply(icu_matrix_et, MARGIN = c(1,2), FUN = function(x) {as.numeric(x)})
icu_matrix_et <- icu_matrix_et[rowSums(icu_matrix_et) > 0,]
str(icu_matrix_et)

```

__Dirichlet-Multinomial Mixture Modelling__

* We perform DMM modeling using the "DirichletMultinomial" package.
* First, we examine each specimen's assignment to a categorical "mixture type":

```{r dmm, echo=TRUE, eval=TRUE, fig.align='center'}

#filter to speed DMM model fitting
icu_matrix_et[rowSums(icu_matrix_et) > 500,] -> small_icu_matrix_et

str(small_icu_matrix_et)

dmm <- lapply(1:10, dmn, count = t(small_icu_matrix_et), verbose = TRUE)

lplc <- sapply(dmm, laplace)

qplot(x = seq_along(lplc), y = lplc)

best_dmm <- dmm[[which.min(lplc)]]

mixture(best_dmm)

mixture(best_dmm) %>%
  as.data.frame() %>%
  as.tibble() %>%
  rownames_to_column() %>%
  dplyr::rename(specimen = rowname) %>%
  dplyr::rename_at(.vars = vars(contains("V")), .funs = function(x) paste0(gsub("V","m",x),"_prob")) %>%
  mutate(assignment = mixture(best_dmm, assign = TRUE)) -> icu_et_dmm_assignments

icu_et_dmm_assignments

icu_et_dmm_assignments %>%
  filter(assignment %in% c(3,5))


```

* Next, we examine each otu's fit to the categorical mixture types:

```{r dmm_fit, echo=TRUE, eval=TRUE, fig.align='center'}

fitted(best_dmm, scale=TRUE) %>%
# scale indicates whether fits scaled by the variability of mixturewt parameter theta
  as.data.frame() %>%
  as.tibble() %>%
  rownames_to_column() %>%
  dplyr::rename(otu_id = rowname) %>%
    dplyr::rename_at(.vars = vars(contains("V")), .funs = function(x) paste0(gsub("V","m",x),"_fit")) -> icu_et_dmm_otu_fits

icu_et_dmm_otu_fits

icu_et_dmm_otu_fits %>%
  gather(key = which_mix, value = mix_fit, -otu_id) %>%
  ggplot(data = .) +
  geom_tile(mapping = aes(x = which_mix, y = otu_id, fill = mix_fit)) +
  scale_fill_viridis()

```

* Finally, we examine the difference between our 5-mixture model and a single-mixture model:

```{r dmm_diff, echo=TRUE, eval=TRUE, fig.align='center'}

abs(fitted(best_dmm, scale=TRUE) - as.vector(fitted(dmm[[1]], scale=TRUE))) %>%
# scale indicates whether fits scaled by the variability of mixturewt parameter theta
  as.data.frame() %>%
  as.tibble() %>%
  rownames_to_column() %>%
  dplyr::rename(otu_id = rowname) %>%
    dplyr::rename_at(.vars = vars(contains("V")), .funs = function(x) paste0(gsub("V","m",x),"_diff_single")) -> icu_et_dmm_otu_diff_single

icu_et_dmm_otu_diff_single

icu_et_dmm_otu_diff_single %>%
  gather(key = which_mix, value = diff, -otu_id) %>%
  ggplot(data = .) +
  geom_tile(mapping = aes(x = which_mix, y = otu_id, fill = diff)) +
  scale_fill_viridis()

```

***
